<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHINIKI | The Divine Domain</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- GSAP for Cinematic Animations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
    
    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <!-- FontAwesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;800&family=Cormorant+Garamond:ital,wght@0,300;0,600;1,400&display=swap" rel="stylesheet">

    <style>
        :root {
            --gold: #D4AF37;
            --deep-gold: #AA8825;
            --ink: #080808;
            --paper: #F0E6D2;
        }

        body {
            margin: 0;
            background-color: var(--ink);
            font-family: 'Cormorant Garamond', serif;
            color: var(--paper);
            overflow-x: hidden;
            cursor: none; /* Custom Cursor */
        }

        /* Custom Cursor */
        #cursor-dot, #cursor-circle {
            position: fixed;
            top: 0;
            left: 0;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            z-index: 9999;
            pointer-events: none;
        }
        #cursor-dot {
            width: 8px;
            height: 8px;
            background-color: var(--gold);
        }
        #cursor-circle {
            width: 40px;
            height: 40px;
            border: 1px solid rgba(212, 175, 55, 0.5);
            transition: width 0.2s, height 0.2s, border-color 0.2s;
        }
        body:hover #cursor-circle {
            width: 60px;
            height: 60px;
            border-color: var(--gold);
        }

        /* 3D Background */
        #webgl-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        /* Typography */
        h1, h2, h3, .cinematic-title {
            font-family: 'Cinzel', serif;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        /* Scroll Sections */
        section {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            padding: 4rem 2rem;
        }

        /* Glass Panels */
        .glass-card {
            background: rgba(10, 10, 10, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(212, 175, 55, 0.1);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            transition: all 0.5s ease;
        }
        .glass-card:hover {
            border-color: rgba(212, 175, 55, 0.4);
            transform: translateY(-5px);
        }

        /* Inputs */
        .noble-input {
            background: transparent;
            border: none;
            border-bottom: 1px solid rgba(212, 175, 55, 0.3);
            color: var(--gold);
            font-family: 'Cinzel', serif;
            transition: 0.3s;
        }
        .noble-input:focus {
            outline: none;
            border-bottom-color: var(--gold);
            background: rgba(212, 175, 55, 0.05);
        }

        /* Buttons */
        .btn-gold {
            position: relative;
            overflow: hidden;
            background: transparent;
            color: var(--gold);
            border: 1px solid var(--gold);
            font-family: 'Cinzel', serif;
            letter-spacing: 0.2em;
            transition: all 0.4s cubic-bezier(0.19, 1, 0.22, 1);
        }
        .btn-gold::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: var(--gold);
            z-index: -1;
            transition: all 0.4s cubic-bezier(0.19, 1, 0.22, 1);
        }
        .btn-gold:hover::before {
            left: 0;
        }
        .btn-gold:hover {
            color: var(--ink);
        }

        /* Upload Area */
        .upload-frame {
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.1);
            transition: 0.5s;
        }
        .upload-frame:hover {
            border-color: var(--gold);
        }
        .corner-mark {
            position: absolute;
            width: 20px;
            height: 20px;
            border: 1px solid var(--gold);
            transition: 0.3s;
            opacity: 0;
        }
        .upload-frame:hover .corner-mark {
            opacity: 1;
        }
        .tl { top: 0; left: 0; border-right: none; border-bottom: none; }
        .tr { top: 0; right: 0; border-left: none; border-bottom: none; }
        .bl { bottom: 0; left: 0; border-right: none; border-top: none; }
        .br { bottom: 0; right: 0; border-left: none; border-top: none; }

        /* Loader */
        .enso-spinner {
            width: 60px;
            height: 60px;
            border: 2px solid rgba(212, 175, 55, 0.1);
            border-top-color: var(--gold);
            border-radius: 50%;
            animation: spin 1s infinite cubic-bezier(0.55, 0.055, 0.675, 0.19);
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Vertical Text */
        .vertical-jp {
            writing-mode: vertical-rl;
            text-orientation: upright;
            letter-spacing: 1em;
            font-family: 'Noto Serif JP', serif;
        }
    </style>
</head>
<body>

    <!-- Custom Cursor -->
    <div id="cursor-dot"></div>
    <div id="cursor-circle"></div>

    <!-- 3D Background -->
    <div id="webgl-container"></div>

    <!-- SCROLL SECTION 1: HERO -->
    <section id="hero">
        <div class="text-center z-10 relative mix-blend-difference">
            <h2 class="text-xs md:text-sm tracking-[1em] mb-4 text-gray-400 uppercase fade-in">Neural Architecture</h2>
            <h1 class="text-6xl md:text-9xl font-bold text-white mb-2 cinematic-title main-title leading-tight">
                SHINIKI
            </h1>
            <div class="w-32 h-[1px] bg-gradient-to-r from-transparent via-yellow-600 to-transparent mx-auto my-6 scale-x-0 separator"></div>
            <p class="text-lg md:text-xl text-gray-300 italic fade-in">"Where Identity Becomes Art"</p>
        </div>
        
        <div class="absolute bottom-10 text-xs tracking-widest text-gray-500 animate-bounce">
            SCROLL TO ENTER
        </div>
    </section>

    <!-- SCROLL SECTION 2: CONNECT -->
    <section id="connect">
        <div class="glass-card p-10 max-w-3xl w-full rounded-sm relative overflow-hidden">
            <div class="absolute top-0 left-0 w-1 h-full bg-yellow-600"></div>
            
            <div class="text-center mb-8">
                <h3 class="text-2xl cinematic-title text-yellow-500 mb-2">Establish Link</h3>
                <p class="text-sm text-gray-400">Enter the gateway key (Ngrok URL) to activate the neural core.</p>
            </div>

            <div class="flex flex-col md:flex-row gap-0 items-end">
                <div class="flex-grow w-full">
                    <label class="text-xs uppercase tracking-widest text-gray-500 mb-2 block">Gateway Key</label>
                    <input type="text" id="serverUrl" placeholder="https://..." class="noble-input w-full p-4 text-xl">
                </div>
                <button onclick="checkConnection()" class="btn-gold px-10 py-4 mt-6 md:mt-0 uppercase text-sm font-bold cursor-none-target">
                    Connect
                </button>
            </div>

            <div id="statusMsg" class="mt-6 text-center text-xs tracking-widest uppercase opacity-50">
                System Standby
            </div>
        </div>
    </section>

    <!-- SCROLL SECTION 3: THE WORKSPACE -->
    <section id="workspace" class="items-start pt-20">
        <div class="w-full max-w-7xl grid lg:grid-cols-2 gap-20 px-6">
            
            <!-- Source -->
            <div class="panel-left">
                <div class="flex justify-between items-baseline mb-6 border-b border-gray-800 pb-4">
                    <h3 class="text-4xl cinematic-title text-white">Source</h3>
                    <span class="text-xs text-yellow-600 tracking-widest uppercase">The Origin</span>
                </div>
                
                <div class="upload-frame h-[600px] bg-black/20 relative flex items-center justify-center group cursor-none-target">
                    <span class="corner-mark tl"></span><span class="corner-mark tr"></span>
                    <span class="corner-mark bl"></span><span class="corner-mark br"></span>
                    
                    <input type="file" id="sourceInput" accept="image/*" onchange="previewImage(this, 'sourcePreview')" 
                        class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-20">
                    
                    <img id="sourcePreview" class="absolute inset-0 w-full h-full object-cover z-10 hidden transition duration-1000">
                    
                    <div id="sourcePlaceholder" class="text-center opacity-40 group-hover:opacity-100 transition duration-500 transform group-hover:scale-105">
                        <i class="fas fa-fingerprint text-4xl mb-4 text-yellow-600"></i>
                        <p class="text-xs tracking-[0.4em] uppercase">Imprint Identity</p>
                    </div>
                </div>
            </div>

            <!-- Target -->
            <div class="panel-right">
                <div class="flex justify-between items-baseline mb-6 border-b border-gray-800 pb-4">
                    <h3 class="text-4xl cinematic-title text-white">Vessel</h3>
                    <span class="text-xs text-yellow-600 tracking-widest uppercase">The Destination</span>
                </div>
                
                <div class="upload-frame h-[600px] bg-black/20 relative flex items-center justify-center group cursor-none-target">
                    <span class="corner-mark tl"></span><span class="corner-mark tr"></span>
                    <span class="corner-mark bl"></span><span class="corner-mark br"></span>
                    
                    <input type="file" id="targetInput" accept="image/*" onchange="previewImage(this, 'targetPreview')" 
                        class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-20">
                    
                    <img id="targetPreview" class="absolute inset-0 w-full h-full object-cover z-10 hidden transition duration-1000">
                    
                    <div id="targetPlaceholder" class="text-center opacity-40 group-hover:opacity-100 transition duration-500 transform group-hover:scale-105">
                        <i class="fas fa-user-astronaut text-4xl mb-4 text-yellow-600"></i>
                        <p class="text-xs tracking-[0.4em] uppercase">Select Host</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- SCROLL SECTION 4: ACTION -->
    <section id="control" class="min-h-[50vh]">
        <div class="text-center relative z-10">
            
            <div class="flex justify-center gap-12 mb-16 text-xs tracking-[0.2em] text-gray-500 uppercase">
                <label class="flex items-center gap-3 cursor-pointer hover:text-yellow-500 transition group">
                    <div class="w-4 h-4 border border-gray-600 group-hover:border-yellow-500 flex items-center justify-center">
                        <div class="w-2 h-2 bg-yellow-500 opacity-0 peer-checked:opacity-100 transition"></div>
                    </div>
                    <input type="checkbox" id="faceEnhanceToggle" class="hidden peer" checked>
                    <span class="group-hover:translate-x-1 transition">Restoration Protocol</span>
                </label>
                
                <label class="flex items-center gap-3 cursor-pointer hover:text-yellow-500 transition group">
                    <div class="w-4 h-4 border border-gray-600 group-hover:border-yellow-500 flex items-center justify-center">
                        <div class="w-2 h-2 bg-yellow-500 opacity-0 peer-checked:opacity-100 transition"></div>
                    </div>
                    <input type="checkbox" id="fullUpscaleToggle" class="hidden peer">
                    <span class="group-hover:translate-x-1 transition">Ultra-Res Upscale</span>
                </label>
            </div>

            <button onclick="swapFaces()" id="swapBtn" disabled 
                class="btn-gold px-16 py-6 text-xl font-bold shadow-[0_0_30px_rgba(212,175,55,0.1)] hover:shadow-[0_0_50px_rgba(212,175,55,0.3)] disabled:opacity-30 disabled:cursor-not-allowed transition-all cursor-none-target">
                INITIATE FUSION
            </button>

            <div id="progressIndicator" class="hidden mt-12">
                <div class="enso-spinner mx-auto"></div>
                <p class="text-yellow-600 mt-6 font-serif text-xs tracking-[0.5em] uppercase animate-pulse">Processing Reality...</p>
            </div>
        </div>
    </section>

    <!-- RESULT OVERLAY (Hidden by default) -->
    <div id="resultOverlay" class="fixed inset-0 z-50 bg-black hidden flex items-center justify-center opacity-0 transition duration-1000">
        <div class="absolute top-10 right-10 cursor-pointer text-gray-500 hover:text-white" onclick="closeResult()">
            <i class="fas fa-times text-2xl"></i>
        </div>
        
        <div class="text-center max-w-4xl w-full px-4">
            <h2 class="text-4xl cinematic-title text-yellow-500 mb-8 tracking-widest">Synthesis Complete</h2>
            <div class="relative p-2 border border-yellow-900/30 bg-black/50 backdrop-blur-md inline-block shadow-2xl">
                <img id="resultImage" class="max-h-[70vh] max-w-full shadow-2xl" />
            </div>
            <div class="mt-10">
                <a id="downloadLink" href="#" download="SHINIKI_Artifact.jpg" class="btn-gold px-10 py-3 text-xs uppercase tracking-widest inline-block cursor-none-target">
                    Download Artifact
                </a>
            </div>
        </div>
    </div>

    <!-- FOOTER -->
    <footer class="py-12 border-t border-white/5 bg-black relative z-10">
        <div class="container mx-auto text-center">
            <div class="flex flex-col items-center gap-4">
                <i class="fas fa-dragon text-3xl text-yellow-700 mb-2"></i>
                <div class="text-xs text-yellow-600 tracking-[0.5em] uppercase">System Administrator</div>
                <div class="text-2xl cinematic-title text-white mb-8">SCXR</div>
                
                <div class="w-px h-8 bg-gray-800 mb-8"></div>
                
                <div class="flex gap-12 text-[10px] uppercase tracking-[0.3em] text-gray-600">
                    <span>Asagi <span class="text-yellow-900">///</span> Arch</span>
                    <span>Yumi <span class="text-yellow-900">///</span> Eng</span>
                    <span>Hayoon <span class="text-yellow-900">///</span> Des</span>
                </div>
            </div>
        </div>
    </footer>

    <script>
        // --- 1. CUSTOM CURSOR LOGIC ---
        const cursorDot = document.getElementById('cursor-dot');
        const cursorCircle = document.getElementById('cursor-circle');

        document.addEventListener('mousemove', (e) => {
            // Smooth lag for circle, instant for dot
            gsap.to(cursorDot, { x: e.clientX, y: e.clientY, duration: 0 });
            gsap.to(cursorCircle, { x: e.clientX, y: e.clientY, duration: 0.15 });
        });

        // Hover effects for buttons
        const targets = document.querySelectorAll('.cursor-none-target, button, input, label, a');
        targets.forEach(target => {
            target.addEventListener('mouseenter', () => {
                gsap.to(cursorCircle, { scale: 2, borderColor: '#D4AF37', backgroundColor: 'rgba(212, 175, 55, 0.1)', duration: 0.3 });
            });
            target.addEventListener('mouseleave', () => {
                gsap.to(cursorCircle, { scale: 1, borderColor: 'rgba(212, 175, 55, 0.5)', backgroundColor: 'transparent', duration: 0.3 });
            });
        });

        // --- 2. THREE.JS CINEMATIC BACKGROUND ---
        const init3D = () => {
            const container = document.getElementById('webgl-container');
            const scene = new THREE.Scene();
            
            // Cinematic Fog
            scene.fog = new THREE.FogExp2(0x080808, 0.0015);

            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 2000);
            camera.position.z = 500;

            const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); // Optimization
            container.appendChild(renderer.domElement);

            // --- THE ARTIFACT (Giant Particle Torus) ---
            const particlesGeometry = new THREE.BufferGeometry();
            const count = 4000;
            
            const positions = new Float32Array(count * 3);
            const colors = new Float32Array(count * 3);
            const sizes = new Float32Array(count);

            const colorInside = new THREE.Color(0xD4AF37); // Gold
            const colorOutside = new THREE.Color(0x8B0000); // Dark Red

            for(let i = 0; i < count; i++) {
                // Torus Knot math
                const u = Math.random() * Math.PI * 2;
                const v = Math.random() * Math.PI * 2;
                const tub = 0.4 + Math.random() * 0.2; // Thickness variance
                
                // Torus Knot Formula (p=2, q=3)
                const radius = 100;
                const tube = 40;
                const p = 2;
                const q = 3;
                
                const r = radius * (2 + Math.cos(q * u)) * 0.5;
                const x = r * Math.cos(p * u);
                const y = r * Math.sin(p * u);
                const z = radius * Math.sin(q * u) * 0.5;

                // Add random spread
                const spreadX = (Math.random() - 0.5) * 30;
                const spreadY = (Math.random() - 0.5) * 30;
                const spreadZ = (Math.random() - 0.5) * 30;

                positions[i * 3] = x + spreadX;
                positions[i * 3 + 1] = y + spreadY;
                positions[i * 3 + 2] = z + spreadZ;

                // Color gradient
                const mixedColor = colorInside.clone().lerp(colorOutside, Math.random());
                colors[i * 3] = mixedColor.r;
                colors[i * 3 + 1] = mixedColor.g;
                colors[i * 3 + 2] = mixedColor.b;

                sizes[i] = Math.random() * 2;
            }

            particlesGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            particlesGeometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
            particlesGeometry.setAttribute('size', new THREE.BufferAttribute(sizes, 1));

            // Custom Material
            const particlesMaterial = new THREE.PointsMaterial({
                size: 2,
                sizeAttenuation: true,
                color: 0xffffff,
                vertexColors: true,
                transparent: true,
                opacity: 0.8,
                blending: THREE.AdditiveBlending
            });

            const artifact = new THREE.Points(particlesGeometry, particlesMaterial);
            scene.add(artifact);

            // Mouse Interaction Variables
            let mouseX = 0;
            let mouseY = 0;
            let targetX = 0;
            let targetY = 0;

            const windowHalfX = window.innerWidth / 2;
            const windowHalfY = window.innerHeight / 2;

            document.addEventListener('mousemove', (event) => {
                mouseX = (event.clientX - windowHalfX) * 0.0005;
                mouseY = (event.clientY - windowHalfY) * 0.0005;
            });

            // Animation Loop
            const clock = new THREE.Clock();

            const animate = () => {
                const elapsedTime = clock.getElapsedTime();

                // Smooth rotation
                targetX = mouseX * 0.5;
                targetY = mouseY * 0.5;
                
                artifact.rotation.y += 0.05 * (targetX - artifact.rotation.y);
                artifact.rotation.x += 0.05 * (targetY - artifact.rotation.x);

                // Continuous slow rotation
                artifact.rotation.z += 0.002;

                // Pulse effect
                const scale = 1 + Math.sin(elapsedTime * 0.5) * 0.05;
                artifact.scale.set(scale, scale, scale);

                // Update geometry for wave effect
                const positions = particlesGeometry.attributes.position.array;
                for(let i=0; i<count; i++) {
                    const x = positions[i*3];
                    // Wiggle logic
                    // positions[i*3+1] += Math.sin(elapsedTime + x * 0.01) * 0.1; 
                }
                particlesGeometry.attributes.position.needsUpdate = true;

                renderer.render(scene, camera);
                requestAnimationFrame(animate);
            };

            animate();

            // --- 3. GSAP SCROLL ANIMATION INTEGRATION ---
            gsap.registerPlugin(ScrollTrigger);

            // Hero Parallax
            gsap.to(camera.position, {
                z: 200, // Fly closer
                scrollTrigger: {
                    trigger: "#hero",
                    start: "top top",
                    end: "bottom top",
                    scrub: true
                }
            });

            // Rotate Artifact on Scroll
            gsap.to(artifact.rotation, {
                x: Math.PI, // Flip it
                scrollTrigger: {
                    trigger: "body",
                    start: "top top",
                    end: "bottom bottom",
                    scrub: 2
                }
            });

            // Connect Section Fade
            gsap.from("#connect .glass-card", {
                y: 100,
                opacity: 0,
                duration: 1.5,
                ease: "power4.out",
                scrollTrigger: {
                    trigger: "#connect",
                    start: "top 80%"
                }
            });

            // Workstation Panels Fly In
            gsap.from(".panel-left", {
                x: -100,
                opacity: 0,
                duration: 1.5,
                ease: "power3.out",
                scrollTrigger: {
                    trigger: "#workspace",
                    start: "top 70%"
                }
            });
            gsap.from(".panel-right", {
                x: 100,
                opacity: 0,
                duration: 1.5,
                ease: "power3.out",
                scrollTrigger: {
                    trigger: "#workspace",
                    start: "top 70%"
                }
            });

            // Handle Resize
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        };

        init3D();


        // --- 4. APP LOGIC (The Brain) ---
        
        // GSAP Intro Animation for Titles
        window.addEventListener('load', () => {
            const tl = gsap.timeline();
            tl.from(".main-title", { duration: 1.5, y: 100, opacity: 0, ease: "power4.out", delay: 0.5 })
              .to(".separator", { duration: 1, scaleX: 1, ease: "expo.out" }, "-=1")
              .from(".fade-in", { duration: 1, y: 20, opacity: 0, stagger: 0.2 }, "-=0.5");
        });

        let serverUrl = "";

        function previewImage(input, imgId) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.getElementById(imgId);
                    img.src = e.target.result;
                    img.classList.remove('hidden');
                    const placeholderId = imgId === 'sourcePreview' ? 'sourcePlaceholder' : 'targetPlaceholder';
                    document.getElementById(placeholderId).classList.add('hidden');
                    
                    // Cinematic Reveal
                    gsap.fromTo(img, {opacity: 0, scale: 1.1}, {opacity: 1, scale: 1, duration: 1});
                    
                    checkReady();
                }
                reader.readAsDataURL(file);
            }
        }

        function updateStatus(msg, type) {
            const el = document.getElementById('statusMsg');
            if (type === 'success') {
                el.innerHTML = `<i class="fas fa-link text-yellow-500 mr-2"></i> LINK ESTABLISHED :: ${msg}`;
                el.style.color = "#D4AF37";
                el.style.opacity = "1";
                gsap.from(el, {y: 10, opacity: 0});
            } else if (type === 'error') {
                el.innerHTML = `<i class="fas fa-exclamation-triangle text-red-500 mr-2"></i> ERROR :: ${msg}`;
                el.style.color = "#ef4444";
                el.style.opacity = "1";
            } else if (type === 'loading') {
                el.innerHTML = `<i class="fas fa-circle-notch fa-spin text-gray-500 mr-2"></i> HANDSHAKING...`;
                el.style.color = "#9ca3af";
            }
        }

        function checkConnection() {
            let inputUrl = document.getElementById('serverUrl').value.trim();
            inputUrl = inputUrl.replace(/\/$/, "");
            
            if(!inputUrl) {
                gsap.to("#serverUrl", {x: 10, duration: 0.1, yoyo: true, repeat: 5}); // Shake effect
                updateStatus("INPUT REQUIRED", "error");
                return;
            }

            updateStatus("INITIATING", "loading");

            fetch(inputUrl + '/', {
                headers: {
                    'ngrok-skip-browser-warning': '69420',
                    'Content-Type': 'application/json'
                }
            })
                .then(response => response.text())
                .then(data => {
                    updateStatus("SYSTEM ONLINE", "success");
                    serverUrl = inputUrl;
                    checkReady();
                    // Smooth scroll to workspace
                    setTimeout(() => {
                        document.getElementById('workspace').scrollIntoView({behavior: 'smooth'});
                    }, 1000);
                })
                .catch(error => {
                    updateStatus("CONNECTION FAILED", "error");
                    console.error(error);
                });
        }

        function checkReady() {
            const source = document.getElementById('sourceInput').files[0];
            const target = document.getElementById('targetInput').files[0];
            const btn = document.getElementById('swapBtn');
            
            if (serverUrl && source && target) {
                btn.disabled = false;
            } else {
                btn.disabled = true;
            }
        }

        function getBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        function closeResult() {
            const overlay = document.getElementById('resultOverlay');
            overlay.classList.add('hidden');
            overlay.style.opacity = 0;
        }

        async function swapFaces() {
            const btn = document.getElementById('swapBtn');
            const indicator = document.getElementById('progressIndicator');
            const resultOverlay = document.getElementById('resultOverlay');
            const resultImg = document.getElementById('resultImage');
            
            const faceEnhance = document.getElementById('faceEnhanceToggle').checked;
            const fullUpscale = document.getElementById('fullUpscaleToggle').checked;
            
            btn.classList.add('hidden');
            indicator.classList.remove('hidden');

            try {
                const sourceFile = document.getElementById('sourceInput').files[0];
                const targetFile = document.getElementById('targetInput').files[0];
                
                const sourceB64 = await getBase64(sourceFile);
                const targetB64 = await getBase64(targetFile);

                const response = await fetch(serverUrl + '/swap', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'ngrok-skip-browser-warning': '69420'
                    },
                    body: JSON.stringify({
                        source: sourceB64,
                        target: targetB64,
                        face_enhance: faceEnhance,
                        full_upscale: fullUpscale
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    resultImg.src = data.result;
                    const downloadLink = document.getElementById('downloadLink');
                    downloadLink.href = data.result;
                    
                    indicator.classList.add('hidden');
                    btn.classList.remove('hidden');
                    
                    // Show Overlay with Animation
                    resultOverlay.classList.remove('hidden');
                    // Force reflow
                    void resultOverlay.offsetWidth; 
                    resultOverlay.style.opacity = 1;
                    
                    updateStatus("COMPLETED", "success");
                } else {
                    alert("Error: " + data.error);
                    updateStatus("FAILED: " + data.error, "error");
                    btn.classList.remove('hidden');
                    indicator.classList.add('hidden');
                }

            } catch (error) {
                alert("Network Error: " + error);
                updateStatus("NETWORK ERROR", "error");
                btn.classList.remove('hidden');
                indicator.classList.add('hidden');
            }
        }
    </script>
</body>
</html>